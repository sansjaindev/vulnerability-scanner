import asyncio
from flask import Flask, request, render_template
import requests
from attacks.scanOpenPorts import scanPorts
from attacks.SQLI import sqli
from attacks.XSS import xss
from attacks.WC import web_crawl
from attacks.DS import run_dirsearch
from attacks.firewall_detection import get_firewall


app = Flask(__name__)
app.jinja_env.filters['is_dict'] = lambda obj: isinstance(obj, dict)
app.jinja_env.filters['is_list'] = lambda obj: isinstance(obj, list)
app.jinja_env.filters['is_set'] = lambda obj: isinstance(obj, set)


@app.route('/')
def home():
	return render_template('index.html')


@app.route('/detect_firewall', methods=['POST'])
def detect_firewall():
	website_url = request.form.get('website')
	wafw00f = request.form.get('wafw00f')

	try:
		response = get_firewall(website_url, wafw00f)
	except requests.exceptions.ConnectTimeout:
		response = 'The site you are trying to connect right now is unavailable. Check the site again or try again later.'

	return render_template('index.html', result=response)


@app.route('/test_sql_injection', methods=['POST'])
def test_sql_injection():
	website_url = request.form.get('website')

	try:
		response = sqli(website_url)
	except requests.exceptions.ConnectTimeout:
		response = 'The site you are trying to connect right now is unavailable. Check the site again or try again later.'
		
	return render_template('index.html', result=response)


@app.route('/test_xss', methods=['POST'])
def test_xss():
	website_url = request.form.get('website')
	
	try:
		response = xss(website_url)
	except requests.exceptions.ConnectTimeout:
		response = 'The site you are trying to connect right now is unavailable. Check the site again or try again later.'
	
	return render_template('index.html', result=response)


@app.route('/web_crawling', methods=['POST'])
def web_crawling():
	website_url = request.form.get('website')
	recursive = request.form.get('recursive')

	try:
		response = asyncio.run(web_crawl(website_url, recursive))
	
	except requests.exceptions.ConnectTimeout:
		response = 'The site you are trying to connect right now is unavailable. Check the site again or try again later.'
	
	return render_template('index.html', result=response)


@app.route('/dir_enum', methods=['POST'])
def dir_enumeration():
	url = request.form.get('website')

	try:
		response = run_dirsearch(url)
	
	except requests.exceptions.ConnectTimeout:
		response = 'The site you are trying to connect right now is unavailable. Check the site again or try again later.'

	return render_template('index.html', result=response)


@app.route('/scan_ports', methods=['POST'])
def scan_ports():
	website_url = request.form.get('website')
	response = scanPorts(website_url)
	return render_template('index.html', result=response)


@app.route('/test_sql_injection', methods=['GET'])
@app.route('/scan_ports', methods=['GET'])
@app.route('/test_xss', methods=['GET'])
@app.route('/web_crawling', methods=['GET'])
@app.route('/dir_enum', methods=['GET'])
def fun():
	return "The page you're trying to access is not available."


if __name__ == '__main__':
	app.run(debug=True, port=5500)
