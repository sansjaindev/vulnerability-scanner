import socket
import nmap
import logging
from attacks.logger import set_logger

set_logger()

log = logging.getLogger(__name__)

def scanPorts(website):
	if website.lower() == 'localhost':
		ip = '127.0.0.1'
	
	website = website.replace('https://', '')
	website = website.replace('http://', '')
	website = website.split('/')
	website = website[0]
	log.info('[!] Scanning for open ports')
		
	ip = socket.gethostbyname(website)
	ip = '%s' % ip

	response = {}

	scanner = nmap.PortScanner()
	scanner.scan(ip, arguments='-O')

	print(f"Open ports for {ip}:")
	for port in scanner[ip]['tcp'].keys():
		if scanner[ip]['tcp'][port]['state'] == "open":
			# response.append(f"{port}/{scanner[ip]['tcp'][port]['name']}")
			log.info(f"[+] Open port detected : {port}/{scanner[ip]['tcp'][port]['name']}")
			response.update({f"{port}/{scanner[ip]['tcp'][port]['name']}" : f"https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword={scanner[ip]['tcp'][port]['name']}"})
	
	if response is None:
		log.info('[-] No open ports detected')
		# response.append('No open port detected')
		response['no open port'] = 'no open port detected'

	print(response)
	return response