import subprocess
import re
import requests

def get_firewall(url, wafw00f):
    if wafw00f:
        command = f'python majorProject/lib/site-packages/wafw00f/main.py {url}'
        try:
            output = subprocess.check_output(command, shell=True, stderr=subprocess.STDOUT, text=True)
        except subprocess.CalledProcessError as e:
            output = f"Error running wafw00f: {e}"
            return output

        strings = output.split('\n')
        response = None        
        for line in strings:
            if '[+]' in line:
                response =  line.strip()
                break

        pattern = r'behind\s+(.*?)\s+WAF'
        match = re.search(pattern, response)

        result = None
        if match:
            result = match.group(1)
            result = '[-] Firewall Detected : ' + result
        
        else:
            result = '[+] Unable to detect firewall.'

        return result
    
    else:
        response = requests.get(url)
        response = response.headers

        server_waf = ['waf', 'cloudflare', 'akamaigHost', 'naxsi', 'yundun', 'big-ip', 'f5 big-ip', 'barracudaWAF', 'akamai', 'sucuri', 'incapsula']
        
        if response.get('server') and response.get('server') in server_waf:
            result = '[-] Firewall detected : ', response.get('server'), 'WAF'

        elif response.get('server') and 'fortiweb' in response.get('server').lower():
            result = 'Fortinet FortiWeb WAF'

        elif response.get('server') and 'imperva' in response.get('server').lower():
            result = 'Imperva SecureSphere WAF'

        elif response.get('server') and 'safe3waf' in response.get('server').lower():
            result = 'Safe3 Web Application Firewall'
        
        elif response.get('x-sucuri-id') or response.get('x-sucuri-cache'):
            result = 'Sucuri CloudProxy WAF'
        
        elif response.get('x-protected-by') and 'sqreen' in response.get('x-protected-by').lower():
            result = 'Sqreen'

        elif response.get('x-waf-event-info'):
            result = 'Reblaze WAF'

        elif response.get('set-cookie') and '_citrix_ns_id' in response.get('set-cookie').lower():
            result = 'Citrix NetScaler'

        elif response.get('x-denied-reason') or response.get('x-wzws-requested-method'):
            result = 'WangZhanBao WAF'

        elif response.get('x-webcoment'):
            result = 'Webcoment Firewall'

        elif response.get('x-yd-waf-info') or response.get('x-yd-info'):
            result = 'Yundun WAF'

        elif response.get('x-datapower-transactionid'):
            result = 'IBM WebSphere DataPower'
        
        else:
            result = '[+] No firewall detected'

        return result
